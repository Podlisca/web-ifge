<!-- Verstecktes Upgrade-Formular für Formspree -->
<form id="upgrade-form"
      action="https://formspree.io/f/xqalakkv"
      method="POST"
      accept-charset="UTF-8"
      style="visibility:hidden; position:absolute; left:-9999px;">
  <input type="hidden" name="Produkt" id="form-produkt">
  <input type="hidden" name="Termin" id="form-termin">
  <input type="hidden" name="Anrede" id="form-anrede">
  <input type="hidden" name="Titel" id="form-titel">
  <input type="hidden" name="Vorname" id="form-vorname">
  <input type="hidden" name="Nachname" id="form-nachname">
  <input type="hidden" name="Email" id="form-email">
  <input type="hidden" name="Strasse" id="form-strasse">
  <input type="hidden" name="PLZ" id="form-plz">
  <input type="hidden" name="Ort" id="form-ort">
  <input type="hidden" name="Land" id="form-land">
  <input type="hidden" name="UID" id="form-uid">
  <input type="hidden" name="Mitteilung" id="form-mitteilung">
  <button type="submit">Senden</button>
</form>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const boxes = document.querySelectorAll('.kursbox, .aufstellung-box');
  const upgrade = document.getElementById('upgrade-form');

  if (!upgrade) return;

  boxes.forEach(function (box) {
    const form = box.querySelector('form');
    if (!form) return;

    form.addEventListener('submit', function (event) {
      event.preventDefault(); // Stripe erst nach Formspree absenden

      const getVal = (selector, index = null) => {
        if (index !== null) {
          return form.querySelectorAll(selector)?.[index]?.value.trim() || '';
        }
        return form.querySelector(selector)?.value.trim() || '';
      };

      const produkt = box.querySelector('h2, h4')?.textContent.trim() || 'Unbekanntes Produkt';
      const termin = box.getAttribute('data-termin') || '';
      const anrede = getVal('select[required]');
      const titel = getVal('select:not([required])');
      const vorname = getVal('input[type="text"]', 0);
      const nachname = getVal('input[type="text"]', 1);
      const email = getVal('input[type="email"]');
      const strasse = getVal('input[type="text"]', 2);
      const plz = getVal('input[type="text"]', 3);
      const ort = getVal('input[type="text"]', 4);
      const land = getVal('input[type="text"]', 5);
      const uid = getVal('input[type="text"]', 6);
      const mitteilung = form.querySelector('textarea')?.value.trim() || '';

      // Hidden-Felder befüllen
      upgrade.querySelector('#form-produkt').value = produkt;
      upgrade.querySelector('#form-termin').value = termin;
      upgrade.querySelector('#form-anrede').value = anrede;
      upgrade.querySelector('#form-titel').value = titel;
      upgrade.querySelector('#form-vorname').value = vorname;
      upgrade.querySelector('#form-nachname').value = nachname;
      upgrade.querySelector('#form-email').value = email;
      upgrade.querySelector('#form-strasse').value = strasse;
      upgrade.querySelector('#form-plz').value = plz;
      upgrade.querySelector('#form-ort').value = ort;
      upgrade.querySelector('#form-land').value = land;
      upgrade.querySelector('#form-uid').value = uid;
      upgrade.querySelector('#form-mitteilung').value = mitteilung;

      console.log("✅ Form wird an Formspree gesendet:", produkt, email);

      // Formular sicher an Formspree senden
      fetch(upgrade.action, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams(new FormData(upgrade)).toString()
      })
      .then(response => {
        console.log("✅ Formspree-Response:", response.status);
      })
      .catch(error => {
        console.error("❌ Fehler beim Senden an Formspree:", error);
      });

      // Danach Stripe öffnen
      setTimeout(() => {
        const stripeLink = form.getAttribute('action');
        if (stripeLink) {
          window.location.href = stripeLink;
        }
      }, 500);
    });
  });
});
</script>
